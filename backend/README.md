# Backend - Todo API

FastAPI backend for the Todo Full-Stack Application (Phase II).

## Features

- ✅ RESTful API with FastAPI
- ✅ SQLModel ORM with PostgreSQL (Neon)
- ✅ JWT authentication (Better Auth integration)
- ✅ User isolation (each user sees only their tasks)
- ✅ Auto-generated API documentation (Swagger/OpenAPI)

## Setup

### 1. Install Dependencies

```bash
# Create virtual environment (recommended)
python -m venv venv

# Activate virtual environment
# Windows:
venv\Scripts\activate
# Mac/Linux:
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Copy `.env.example` to `.env` and update with your credentials:

```bash
cp .env.example .env
```

Edit `.env`:
```
DATABASE_URL=your-neon-postgresql-url
BETTER_AUTH_SECRET=your-secret-here
CORS_ORIGINS=http://localhost:3000
```

### 3. Run the Server

```bash
# Development mode (with auto-reload)
uvicorn main:app --reload

# Or use Python directly
python main.py
```

The API will be available at:
- **API**: http://localhost:8000
- **Docs**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## API Endpoints

All endpoints require JWT authentication via `Authorization: Bearer <token>` header.

### Tasks

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/{user_id}/tasks` | List all user's tasks |
| POST | `/api/{user_id}/tasks` | Create a new task |
| GET | `/api/{user_id}/tasks/{id}` | Get a specific task |
| PUT | `/api/{user_id}/tasks/{id}` | Update a task |
| DELETE | `/api/{user_id}/tasks/{id}` | Delete a task |
| PATCH | `/api/{user_id}/tasks/{id}/complete` | Toggle completion |

### Health Check

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Health check endpoint |

## Project Structure

```
backend/
├── main.py           # FastAPI app entry point
├── models.py         # SQLModel database models
├── database.py       # Database connection
├── auth.py           # JWT authentication
├── routes.py         # API route handlers
├── requirements.txt  # Python dependencies
├── .env              # Environment variables (not in git)
├── .env.example      # Environment template
└── README.md         # This file
```

## Database Schema

### Tasks Table

```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id TEXT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id);
```

## Authentication

The backend verifies JWT tokens generated by Better Auth on the frontend.

**Token Flow**:
1. Frontend generates JWT token (Better Auth)
2. Frontend sends token in `Authorization: Bearer <token>` header
3. Backend verifies token signature using `BETTER_AUTH_SECRET`
4. Backend extracts `user_id` from token
5. Backend filters all queries by `user_id`

## Development

### Testing with Swagger UI

1. Start the server
2. Go to http://localhost:8000/docs
3. Click "Authorize" and enter your JWT token
4. Try the endpoints

### Testing with curl

```bash
# Get tasks
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:8000/api/USER_ID/tasks

# Create task
curl -X POST \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Buy groceries","description":"Milk, eggs"}' \
  http://localhost:8000/api/USER_ID/tasks
```

## Deployment

### Railway

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Deploy
railway up
```

### Render

1. Connect your GitHub repository
2. Select "Web Service"
3. Set build command: `pip install -r requirements.txt`
4. Set start command: `uvicorn main:app --host 0.0.0.0 --port $PORT`
5. Add environment variables
6. Deploy

## Environment Variables (Production)

```
DATABASE_URL=postgresql://...
BETTER_AUTH_SECRET=your-secret-here
CORS_ORIGINS=https://your-frontend.vercel.app
ENVIRONMENT=production
```

## Troubleshooting

### Database Connection Issues

- Verify `DATABASE_URL` is correct
- Check Neon database is running
- Ensure SSL mode is enabled

### JWT Verification Errors

- Verify `BETTER_AUTH_SECRET` matches frontend
- Check token is not expired
- Ensure token format is correct

### CORS Errors

- Add frontend URL to `CORS_ORIGINS`
- Check CORS middleware is configured
- Verify credentials are allowed

## License

Part of Hackathon II - Phase II
